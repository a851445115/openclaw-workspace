#!/usr/bin/env bash
set -euo pipefail

ROOT="${1:-$(mktemp -d)}"
ROOT_STATE="$(mktemp -d)"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MILESTONE_PY="$SCRIPT_DIR/lib/milestones.py"
BOARD_PY="$SCRIPT_DIR/lib/task_board.py"

if [[ ! -d "$ROOT/state" ]]; then
  mkdir -p "$ROOT"
fi

"$SCRIPT_DIR/init-task-board" --root "$ROOT" >/dev/null

sha256_file() {
  if command -v shasum >/dev/null 2>&1; then
    shasum -a 256 "$1" | awk '{print $1}'
  else
    sha256sum "$1" | awk '{print $1}'
  fi
}

TASKS_FILE="$ROOT/state/tasks.jsonl"
SNAPSHOT_FILE="$ROOT/state/tasks.snapshot.json"
TASKS_SHA_BEFORE="$(sha256_file "$TASKS_FILE")"
SNAPSHOT_SHA_BEFORE="$(sha256_file "$SNAPSHOT_FILE")"

"$SCRIPT_DIR/orchestrator-router" --root "$ROOT" --actor orchestrator --milestones dry-run   --text "@orchestrator create project MVP: 搭建插件骨架; 实现任务看板; 实现命令路由" >/dev/null
"$SCRIPT_DIR/orchestrator-router" --root "$ROOT" --actor orchestrator --milestones dry-run   --text "@orchestrator run" >/dev/null

STATUS_JSON="$($SCRIPT_DIR/orchestrator-router --root "$ROOT" --actor orchestrator --milestones dry-run --text "status")"
STATUS_FULL_JSON="$($SCRIPT_DIR/orchestrator-router --root "$ROOT" --actor orchestrator --milestones dry-run --text "status full")"

python3 - <<'PY2' "$STATUS_JSON" "$STATUS_FULL_JSON"
import json
import sys
status = json.loads(sys.argv[1])
status_full = json.loads(sys.argv[2])
msg = status["send"]["payload"]["text"]
msg_full = status_full["send"]["payload"]["text"]
assert "阻塞Top" in msg, msg
assert "待推进Top" in msg, msg
assert len(msg) <= 500, len(msg)
assert "Top6" in msg_full, msg_full
print("dry-run status checks passed")
PY2

TASKS_SHA_AFTER="$(sha256_file "$TASKS_FILE")"
SNAPSHOT_SHA_AFTER="$(sha256_file "$SNAPSHOT_FILE")"
if [[ "$TASKS_SHA_BEFORE" != "$TASKS_SHA_AFTER" ]]; then
  echo "dry-run mutated state/tasks.jsonl" >&2
  exit 1
fi
if [[ "$SNAPSHOT_SHA_BEFORE" != "$SNAPSHOT_SHA_AFTER" ]]; then
  echo "dry-run mutated state/tasks.snapshot.json" >&2
  exit 1
fi

"$SCRIPT_DIR/init-task-board" --root "$ROOT_STATE" >/dev/null
python3 "$MILESTONE_PY" feishu-router --root "$ROOT_STATE" --actor orchestrator --mode dry-run   --text "@orchestrator create project MVP: 搭建插件骨架; 实现任务看板; 实现命令路由" >/dev/null
RUN_CLAIM_JSON="$(python3 "$MILESTONE_PY" feishu-router --root "$ROOT_STATE" --actor orchestrator --mode dry-run --text "@orchestrator run")"
python3 "$BOARD_PY" apply --root "$ROOT_STATE" --actor orchestrator --text "mark done T-001: dry-run done" >/dev/null

RUN_DONE_JSON="$(python3 "$MILESTONE_PY" feishu-router --root "$ROOT_STATE" --actor orchestrator --mode dry-run --text "@orchestrator run T-001")"
set +e
BLOCK_DONE_JSON="$(python3 "$BOARD_PY" apply --root "$ROOT_STATE" --actor orchestrator --text "block task T-001: spawn timeout" 2>/dev/null)"
BLOCK_DONE_RC=$?
set -e
python3 "$BOARD_PY" apply --root "$ROOT_STATE" --actor coder --text "@coder create task T-900: blockable dispatch test" >/dev/null
python3 "$BOARD_PY" apply --root "$ROOT_STATE" --actor coder --text "@coder claim task T-900" >/dev/null
python3 "$BOARD_PY" apply --root "$ROOT_STATE" --actor orchestrator --text "block task T-900: spawn timeout" >/dev/null

python3 - <<'PY2' "$ROOT_STATE" "$RUN_CLAIM_JSON" "$RUN_DONE_JSON" "$BLOCK_DONE_JSON" "$BLOCK_DONE_RC"
import json
import sys
from pathlib import Path
root = Path(sys.argv[1])
run_claim = json.loads(sys.argv[2])
run_done = json.loads(sys.argv[3])
block_done = json.loads(sys.argv[4]) if sys.argv[4] else {}
block_done_rc = int(sys.argv[5])
assert run_claim.get("intent") == "dispatch", run_claim
assert run_claim.get("waitForReport") is True, run_claim
assert run_claim.get("autoClose") is False, run_claim
assert run_claim.get("claim", {}).get("status") == "claimed", run_claim
assert '<at user_id="ou_f938eaffd79cf1837c3c7c6cd5089235">' in run_claim.get("taskSend", {}).get("payload", {}).get("text", ""), run_claim
assert '<at user_id="ou_f938eaffd79cf1837c3c7c6cd5089235">' in run_claim.get("reportTemplate", ""), run_claim
run_msg = run_done["send"]["payload"]["text"]
assert run_done.get("idempotent") is True, run_done
assert run_msg == "[DONE] T-001 已完成，无需重复执行", run_msg
assert block_done_rc != 0, block_done_rc
assert "invalid transition" in (block_done.get("error") or ""), block_done
snap = json.loads((root / "state/tasks.snapshot.json").read_text())
assert snap["tasks"]["T-001"]["status"] == "done", snap["tasks"]["T-001"]
assert snap["tasks"]["T-900"]["status"] == "blocked", snap["tasks"]["T-900"]
print("idempotent run + blocked transition checks passed")
PY2

echo "$RUN_DONE_JSON"
echo "$STATUS_JSON"
echo "$STATUS_FULL_JSON"
echo "dry-run root: $ROOT"
echo "stateful test root: $ROOT_STATE"
